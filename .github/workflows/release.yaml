name: Release

on:
  workflow_call:
    inputs:
      vendor:
        required: true
        type: string
      package:
        required: true
        type: string
      tag:
        required: false
        type: string
      do_enable_js:
        required: false
        type: boolean
      do_enable_php:
        required: false
        type: boolean
      php_version:
        required: false
        type: string
      node_version:
        required: false
        type: string
      bun_version:
        required: false
        type: string
      dry_run:
        required: false
        type: boolean
    secrets:
      NPM_TOKEN:
        required: false
      PACKAGIST_USERNAME:
        required: false
      PACKAGIST_TOKEN:
        required: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  validate-inputs:
    uses: brnshkr/config/.github/workflows/validate-inputs.yaml@master
    with:
      do_validate_secrets: 'true'
      do_enable_js: ${{ inputs.do_enable_js || github.event.inputs.do_enable_js || env.DO_ENABLE_JS || '' }}
      do_enable_php: ${{ inputs.do_enable_php || github.event.inputs.do_enable_php || env.DO_ENABLE_PHP || '' }}
      php_version: ${{ inputs.php_version || github.event.inputs.php_version || env.PHP_VERSION || '' }}
      node_version: ${{ inputs.node_version || github.event.inputs.node_version || env.NODE_VERSION || '' }}
      bun_version: ${{ inputs.bun_version || github.event.inputs.bun_version || env.BUN_VERSION || '' }}
      dry_run: ${{ inputs.dry_run || github.event.inputs.dry_run || env.DRY_RUN || 'false' }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      PACKAGIST_USERNAME: ${{ secrets.PACKAGIST_USERNAME }}
      PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}

  build:
    uses: brnshkr/config/.github/workflows/build.yaml@master
    needs: validate-inputs
    with:
      do_enable_js: ${{ needs.validate-inputs.outputs.do_enable_js }}
      do_enable_php: ${{ needs.validate-inputs.outputs.do_enable_php }}
      php_version: ${{ needs.validate-inputs.outputs.php_version }}
      bun_version: ${{ needs.validate-inputs.outputs.bun_version }}
      dry_run: ${{ needs.validate-inputs.outputs.dry_run }}

  release:
    name: Build, changelog and publish
    runs-on: ubuntu-latest
    needs:
      - validate-inputs
      - build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Normalize release input tag
        run: |
          INPUT_TAG=${{ inputs.tag || github.event.inputs.tag || env.INPUT_TAG || '' }}
          echo "INPUT_TAG=$INPUT_TAG" >> $GITHUB_ENV

      - name: Validate branch, ensure package versions match and create tag
        run: |
          set -euo pipefail
          echo "Reading versions, descriptions, and names from package.json and composer.json"
          package_json_version=$(python3 -c "import json;print(json.load(open('package.json'))['version'])") || true
          package_json_description=$(python3 -c "import json;print(json.load(open('package.json'))['description'])") || true
          package_json_name=$(python3 -c "import json;print(json.load(open('package.json'))['name'])") || true
          composer_json_version=$(python3 -c "import json;print(json.load(open('composer.json'))['version'])") || true
          composer_json_description=$(python3 -c "import json;print(json.load(open('composer.json'))['description'])") || true
          composer_json_name=$(python3 -c "import json;print(json.load(open('composer.json'))['name'])") || true
          echo "package.json version: $package_json_version"
          echo "package.json description: $package_json_description"
          echo "package.json name: $package_json_name"
          echo "composer.json version: $composer_json_version"
          echo "composer.json description: $composer_json_description"
          echo "composer.json name: $composer_json_name"
          if [ -z "${package_json_version:-}" ] || [ -z "${composer_json_version:-}" ]; then
            echo "Could not read versions from package.json or composer.json" >&2
            exit 1
          fi
          if [ -z "${package_json_description:-}" ] || [ -z "${composer_json_description:-}" ]; then
            echo "Could not read descriptions from package.json or composer.json" >&2
            exit 1
          fi
          if [ -z "${package_json_name:-}" ] || [ -z "${composer_json_name:-}" ]; then
            echo "Could not read names from package.json or composer.json" >&2
            exit 1
          fi
          if [ "$package_json_version" != "$composer_json_version" ]; then
            echo "Version mismatch: package.json ($package_json_version) != composer.json ($composer_json_version)" >&2
            exit 1
          fi
          if [ "$package_json_description" != "$composer_json_description" ]; then
            echo "Description mismatch: package.json ($package_json_description) != composer.json ($composer_json_description)" >&2
            exit 1
          fi
          normalized_npm_name="${package_json_name#@}"
          expected_name="${VENDOR}/${PACKAGE}"
          echo "Normalized NPM name: $normalized_npm_name"
          echo "Composer package name: $composer_json_name"
          echo "Expected package name: $expected_name"
          if [ "$normalized_npm_name" != "$expected_name" ]; then
            echo "Package name mismatch: package.json ($normalized_npm_name) != expected ($expected_name)" >&2
            exit 1
          fi
          if [ "$composer_json_name" != "$expected_name" ]; then
            echo "Package name mismatch: composer.json ($composer_json_name) != expected ($expected_name)" >&2
            exit 1
          fi
          INPUT_TAG="${INPUT_TAG:-}"
          if [ -n "$INPUT_TAG" ]; then
            TAG="$INPUT_TAG"
          else
            TAG="$package_json_version"
          fi
          echo "Requested release tag: $TAG"
          if echo "$TAG" | grep -qE '^v'; then
            echo "v-prefixed tags are not accepted. Tag with 'X.Y.Z' (no leading 'v')." >&2
            exit 1
          fi
          if ! echo "$TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+([-.+].*)?$'; then
            echo "Tag '$TAG' does not match semver (X.Y.Z with optional suffix)." >&2
            exit 1
          fi
          if [ "$TAG" != "$package_json_version" ]; then
            echo "Tag '$TAG' does not match package.json/composer.json version '$package_json_version'." >&2
            exit 1
          fi
          echo "Tag, versions, descriptions, and package names match"
          if echo "${GITHUB_REF:-}" | grep -qE '^refs/heads/release/'; then
            echo "Run triggered from release branch; creating and pushing tag '$TAG'"
            GIT_NAME="${GITHUB_ACTOR:-github-actions[bot]}"
            GIT_EMAIL="${GITHUB_ACTOR:-github-actions[bot]}@users.noreply.github.com"
            git config user.name "$GIT_NAME"
            git config user.email "$GIT_EMAIL"
            if [ "${DRY_RUN:-false}" = "true" ]; then
              echo "Dry run: would tag and push $TAG"
            else
              git tag -a "$TAG" -m "Release $TAG"
              git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}" refs/tags/$TAG
            fi
            sleep 2
          fi
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      - name: Setup Node (for changelog and npm publish)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.validate-inputs.outputs.node_version }}
          registry-url: 'https://registry.npmjs.org'
          cache: npm

      - name: Generate changelog
        run: |
          npx -y conventional-changelog -r 0 -o CHANGELOG.md

      - name: Extract release notes for tag
        id: release_notes
        run: |
          awk 'BEGIN{p=0} /^## /{if(p==0){p=1; print; next} else {exit}} p==1{print}' CHANGELOG.md > /tmp/RELEASE_NOTES.md || true
          sed -E 's/^## v/## /' /tmp/RELEASE_NOTES.md > /tmp/RELEASE_NOTES_STRIPPED.md || true
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/RELEASE_NOTES_STRIPPED.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        if: ${{ needs.validate-inputs.outputs.dry_run != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.RELEASE_TAG }}
          tag_name: ${{ env.RELEASE_TAG }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            ./artifacts/*

      - name: Skip GitHub release
        if: ${{ needs.validate-inputs.outputs.dry_run == 'true' }}
        run: echo "Dry run enabled, skipping GitHub release creation."

      - name: Publish NPM package
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' && secrets.NPM_TOKEN != '' && needs.validate-inputs.outputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          echo "Publishing npm package from artifacts"
          max_attempts=4
          for f in ./artifacts/*.tgz; do
            [ -f "$f" ] || continue
            attempt=1
            while true; do
              echo "Attempt ${attempt} publishing ${f}"
              if npm publish "$f" --access public; then
                echo "Published ${f}"
                break
              fi
              if [ $attempt -ge $max_attempts ]; then
                echo "Failed to publish ${f} after ${max_attempts} attempts" >&2
                exit 1
              fi
              sleep_sec=$((2 ** (attempt - 1) * 2))
              echo "Publish failed; retrying in ${sleep_sec}s..."
              sleep $sleep_sec
              attempt=$((attempt + 1))
            done
          done

      - name: Skip NPM publish
        if: ${{ needs.validate-inputs.outputs.do_enable_js != 'true' || secrets.NPM_TOKEN == '' || needs.validate-inputs.outputs.dry_run == 'true' }}
        run: echo "NPM publish skipped due to configuration."

      - name: Ensure Packagist package exists
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' && secrets.PACKAGIST_USERNAME != '' && secrets.PACKAGIST_TOKEN != '' && needs.validate-inputs.outputs.dry_run != 'true' }}
        env:
          PACKAGIST_USERNAME: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}
          DRY_RUN: ${{ needs.validate-inputs.outputs.dry_run }}
          VENDOR: ${{ inputs.vendor || github.event.inputs.vendor || env.VENDOR }}
          PACKAGE: ${{ inputs.package || github.event.inputs.package || env.PACKAGE }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        run: |
          set -euo pipefail
          echo "Checking Packagist for ${VENDOR}/${PACKAGE}"
          status=$(curl -s -o /dev/null -w "%{http_code}" "https://packagist.org/packages/${VENDOR}/${PACKAGE}.json") || true
          if [ "$status" = "200" ]; then
            echo "Package ${VENDOR}/${PACKAGE} already exists on Packagist (HTTP $status)."
            exit 0
          fi
          echo "Package not found on Packagist (HTTP $status)."
          if [ "${DRY_RUN:-false}" = "true" ]; then
            echo "Dry run: would attempt create-package for ${REPO_URL}"
            exit 0
          fi
          echo "Attempting to create (with retries)..."
          max_attempts=4
          attempt=1
          success=0
          while [ $attempt -le $max_attempts ]; do
            resp=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${PACKAGIST_USERNAME}:${PACKAGIST_TOKEN}" \
              -H "User-Agent: GitHub-Actions (mailto:actions@users.noreply.github.com)" \
              https://packagist.org/api/create-package -d "{\"repository\":\"${REPO_URL}\"}") || true
            code=$(echo "$resp" | tail -n1)
            if [ "$code" = "200" ] || [ "$code" = "201" ]; then
              echo "create-package succeeded (HTTP $code)."
              success=1
              break
            fi
            echo "create-package attempt $attempt returned HTTP $code; retrying..."
            sleep_sec=$((2 ** (attempt - 1) * 2))
            sleep $sleep_sec
            attempt=$((attempt + 1))
          done
          if [ $success -ne 1 ]; then
            echo "Warning: create-package failed after $max_attempts attempts; proceeding to update-package which may still succeed."
          fi

      - name: Skip Packagist package exists check
        if: ${{ needs.validate-inputs.outputs.do_enable_php != 'true' || secrets.PACKAGIST_USERNAME == '' || secrets.PACKAGIST_TOKEN == '' || needs.validate-inputs.outputs.dry_run == 'true' }}
        run: echo "Packagist ensure skipped due to configuration."

      - name: Notify Packagist
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' && secrets.PACKAGIST_USERNAME != '' && secrets.PACKAGIST_TOKEN != '' && needs.validate-inputs.outputs.dry_run != 'true' }}
        env:
          PACKAGIST_USERNAME: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}
          REPO_URL: 'https://github.com/brnshkr/config'
        run: |
          set -euo pipefail
          echo "Notifying Packagist to update package metadata for $REPO_URL (with retries)"
          max_attempts=4
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            resp=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${PACKAGIST_USERNAME}:${PACKAGIST_TOKEN}" \
              -H "User-Agent: GitHub-Actions (mailto:actions@users.noreply.github.com)" \
              https://packagist.org/api/update-package -d "{\"repository\":\"${REPO_URL}\"}") || true
            code=$(echo "$resp" | tail -n1)
            if [ "$code" = "200" ] || [ "$code" = "201" ]; then
              echo "update-package succeeded (HTTP $code)."
              break
            fi
            echo "update-package attempt $attempt returned HTTP $code; retrying..."
            sleep_sec=$((2 ** (attempt - 1) * 2))
            sleep $sleep_sec
            attempt=$((attempt + 1))
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "Warning: update-package failed after $max_attempts attempts."
          fi

      - name: Skip Packagist notify
        if: ${{ needs.validate-inputs.outputs.do_enable_php != 'true' || secrets.PACKAGIST_USERNAME == '' || secrets.PACKAGIST_TOKEN == '' || needs.validate-inputs.outputs.dry_run == 'true' }}
        run: echo "Packagist notify skipped due to configuration."
