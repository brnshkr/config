name: Build

on:
  workflow_call:
    inputs:
      do_enable_js:
        required: false
        type: boolean
      do_enable_php:
        required: false
        type: boolean
      php_version:
        required: false
        type: string
      bun_version:
        required: false
        type: string
      dry_run:
        required: false
        type: boolean

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate-inputs:
    uses: brnshkr/config/.github/workflows/validate-inputs.yaml@master
    with:
      do_enable_js: ${{ inputs.do_enable_js || github.event.inputs.do_enable_js || '' }}
      do_enable_php: ${{ inputs.do_enable_php || github.event.inputs.do_enable_php || '' }}
      php_version: ${{ inputs.php_version || github.event.inputs.php_version || env.PHP_VERSION || '' }}
      bun_version: ${{ inputs.bun_version || github.event.inputs.bun_version || env.BUN_VERSION || '' }}
      dry_run: ${{ inputs.dry_run || github.event.inputs.dry_run || needs.validate-inputs.outputs.dry_run || 'false' }}

  build-js:
    name: Build JS package
    runs-on: ubuntu-latest
    needs: validate-inputs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        with:
          bun-version: ${{ needs.validate-inputs.outputs.bun_version }}

      - name: Handle cache
        uses: actions/cache@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        with:
          path: |
            ~/.bun
          key: ${{ runner.os }}-bun-${{ hashFiles('package.json', 'bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        run: bun install

      - name: Build
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        run: bun run build

      - name: Create NPM package
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' && needs.validate-inputs.outputs.dry_run != 'true' }}
        run: |
          npm pack --pack-destination ./artifacts

      - name: Skip
        if: ${{ needs.validate-inputs.outputs.do_enable_js != 'true' }}
        run: echo "JS build disabled, skipping."

  build-php:
    name: Build PHP package
    runs-on: ubuntu-latest
    needs: validate-inputs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        with:
          php-version: ${{ needs.validate-inputs.outputs.php_version }}

      - name: Handle cache
        uses: actions/cache@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        with:
          path: |
            ~/.composer/cache
            ~/.cache/composer
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.json', 'composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Create Composer package
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' && needs.validate-inputs.outputs.dry_run != 'true' }}
        run: |
          composer archive --dir=./artifacts

      - name: Skip
        if: ${{ needs.validate-inputs.outputs.do_enable_php != 'true' }}
        run: echo "PHP build disabled, skipping."

  upload-artifacts:
    name: Upload artifacts
    runs-on: ubuntu-latest
    needs:
      - build-js
      - build-php
    steps:
      - name: Upload
        if: ${{ needs.validate-inputs.outputs.dry_run != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: ./artifacts

      - name: Skip
        if: ${{ needs.validate-inputs.outputs.dry_run == 'true' }}
        run: echo "Dry run enabled, skipping artifact upload."
