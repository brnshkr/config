name: Check

on:
  workflow_call:
    inputs:
      do_enable_js:
        required: false
        type: boolean
      do_enable_php:
        required: false
        type: boolean
      php_version:
        required: false
        type: string
      bun_version:
        required: false
        type: string

concurrency:
  group: check-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate-inputs:
    uses: brnshkr/config/.github/workflows/validate-inputs.yaml@master
    with:
      do_enable_js: ${{ inputs.do_enable_js || github.event.inputs.do_enable_js || env.DO_ENABLE_JS || '' }}
      do_enable_php: ${{ inputs.do_enable_php || github.event.inputs.do_enable_php || env.DO_ENABLE_PHP || '' }}
      php_version: ${{ inputs.php_version || github.event.inputs.php_version || env.PHP_VERSION || '' }}
      bun_version: ${{ inputs.bun_version || github.event.inputs.bun_version || env.BUN_VERSION || '' }}

  commitlint:
    name: Check commit messages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run commitlint
        uses: wagoid/commitlint-github-action@v6
        with:
          configFile: ./.conf/commitlint.config.mjs

  check-versions:
    name: Check versions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check matching versions
        run: |
          set -euo pipefail
          echo "Reading versions from package.json and composer.json"
          package_json_version=$(python3 -c "import json;print(json.load(open('package.json'))['version'])") || true
          composer_json_version=$(python3 -c "import json;print(json.load(open('composer.json'))['version'])") || true
          echo "package.json version: $package_json_version"
          echo "composer.json version: $composer_json_version"
          if [ -z "${package_json_version:-}" ] || [ -z "${composer_json_version:-}" ]; then
            echo "Could not read versions from package.json or composer.json" >&2
            exit 1
          fi
          if [ "$package_json_version" != "$composer_json_version" ]; then
            echo "Version mismatch: package.json ($package_json_version) != composer.json ($composer_json_version)" >&2
            exit 1
          fi
          echo "Versions are in sync: $package_json_version"

  check-js:
    name: Check JS
    runs-on: ubuntu-latest
    needs:
      - commitlint
      - validate-inputs
      - check-versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        with:
          bun-version: ${{ needs.validate-inputs.outputs.bun_version }}

      - name: Handle cache
        uses: actions/cache@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        with:
          path: |
            ~/.bun
          key: ${{ runner.os }}-bun-${{ hashFiles('package.json', 'bun.lock') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        run: bun install

      - name: Run checks
        if: ${{ needs.validate-inputs.outputs.do_enable_js == 'true' }}
        run: bun check

      - name: Skip
        if: ${{ needs.validate-inputs.outputs.do_enable_js != 'true' }}
        run: echo "JS disabled, skipping."

  check-php:
    name: Check PHP
    runs-on: ubuntu-latest
    needs:
      - commitlint
      - validate-inputs
      - check-versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        with:
          php-version: ${{ needs.validate-inputs.outputs.php_version }}
          coverage: none

      - name: Handle cache
        uses: actions/cache@v4
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        with:
          path: |
            ~/.composer/cache
            ~/.cache/composer
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.json', 'composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Run checks
        if: ${{ needs.validate-inputs.outputs.do_enable_php == 'true' }}
        run: make check

      - name: Skip
        if: ${{ needs.validate-inputs.outputs.do_enable_php != 'true' }}
        run: echo "PHP disabled, skipping."
