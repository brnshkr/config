name: Validate Inputs

on:
  workflow_call:
    inputs:
      do_validate_secrets:
        required: false
        type: boolean
      do_enable_js:
        required: false
        type: boolean
      do_enable_php:
        required: false
        type: boolean
      php_version:
        required: false
        type: string
      node_version:
        required: false
        type: string
      bun_version:
        required: false
        type: string
      dry_run:
        required: false
        type: boolean
    secrets:
      NPM_TOKEN:
        required: false
      PACKAGIST_USERNAME:
        required: false
      PACKAGIST_TOKEN:
        required: false

jobs:
  validate:
    name: Validate inputs and required secrets
    runs-on: ubuntu-latest
    outputs:
      do_enable_js: ${{ steps.set.outputs.do_enable_js }}
      do_enable_php: ${{ steps.set.outputs.do_enable_php }}
      node_version: ${{ steps.set.outputs.node_version }}
      php_version: ${{ steps.set.outputs.php_version }}
      bun_version: ${{ steps.set.outputs.bun_version }}
      dry_run: ${{ steps.set.outputs.dry_run }}
    steps:
      - name: Normalize and validate inputs
        id: set
        run: |
          set -euo pipefail
          IN_DO_VALIDATE_SECRETS="${{ inputs.do_validate_secrets|| env.DO_VALIDATE_SECRETS || 'false' }}"
          IN_DO_ENABLE_JS="${{ inputs.do_enable_js|| env.DO_ENABLE_JS || 'false' }}"
          IN_DO_ENABLE_PHP="${{ inputs.do_enable_php|| env.DO_ENABLE_PHP || 'false' }}"
          IN_NODE_VER="${{ inputs.node_version || env.NODE_VERSION || '' }}"
          IN_BUN_VER="${{ inputs.bun_version || env.BUN_VERSION || '' }}"
          IN_PHP_VER="${{ inputs.php_version || env.PHP_VERSION || '' }}"
          IN_DRY_RUN="${{ inputs.dry_run || 'false' }}"

          if [ "$IN_DO_ENABLE_JS" = "true" ]; then
            if [ -z "$IN_NODE_VER" ] || [ -z "$IN_BUN_VER" ]; then
              echo "When JS is enabled you must provide node_version and bun_version (or set NODE_VERSION/BUN_VERSION)." >&2
              exit 1
            fi
            if [ "$IN_DO_VALIDATE_SECRETS" = "true" ]; then
              if [ "${{ github.event_name }}" = "workflow_call" ] && [ "${{ secrets.NPM_TOKEN }}" = "" ]; then
                echo "NPM_TOKEN secret is required when validating secrets for JS." >&2
                exit 1
              fi
            fi
          fi
          if [ "$IN_DO_ENABLE_PHP" = "true" ]; then
            if [ -z "$IN_PHP_VER" ]; then
              echo "When PHP is enabled you must provide php_version (or set PHP_VERSION)." >&2
              exit 1
            fi
            if [ "$IN_DO_VALIDATE_SECRETS" = "true" ]; then
              if [ "${{ github.event_name }}" = "workflow_call" ] && { [ "${{ secrets.PACKAGIST_USERNAME }}" = "" ] || [ "${{ secrets.PACKAGIST_TOKEN }}" = "" ]; }; then
                echo "PACKAGIST_USERNAME and PACKAGIST_TOKEN are required when validating secrets for PHP." >&2
                exit 1
              fi
            fi
          fi

          echo "do_enable_js=$IN_DO_ENABLE_JS" >> $GITHUB_OUTPUT
          echo "do_enable_php=$IN_DO_ENABLE_PHP" >> $GITHUB_OUTPUT
          echo "node_version=$IN_NODE_VER" >> $GITHUB_OUTPUT
          echo "php_version=$IN_PHP_VER" >> $GITHUB_OUTPUT
          echo "bun_version=$IN_BUN_VER" >> $GITHUB_OUTPUT
          echo "dry_run=$IN_DRY_RUN" >> $GITHUB_OUTPUT
